# September

## September 4th

### Notes:
Today I began refactoring the hazard unit testbench. This module is very important to the execution of the whole system, so it's very important that it is thoroughly verified, especially with the complications included through the addition of the instruction cache, and branch predictor. 

To start, I decided it would be best to make use of more tasks, one for each expected case I wanted to test. In this way I can make each case I want to test it's own block of code that can be updated as needed. This extra organization should make future changes much easier to verify. 

Each scenario will have a driver task, which will set **only** the related signals, and a checker task that will assert the expected results. The scenario drivers can be combined to test when multiple hazards may overlap (like a load stall, and cache miss at the same time), however these combined scenarios will require their own checker tasks to handle priority.

Today was a short day, so I essentially just made this decision, and layed out some of the tasks that need to be created within the hazard unit testbench. Note that this kind of refactor will not be done for most testbenches, however I feel it is worth it for this one, as the hazard signals are so important in how the processor functions.

### Summary
- Decided on testing method for hazard unit
- Layed out tasks to create
  
## September 6th

### Notes:
Today I implemented the changes to the hazard unit tb. This ended up being a pretty split development. I created some drive* tasks for simple situations, scenario* tasks for more complex situations, and then expect* tasks for both. Essentially, when a situation was multi-cycle, and dependant on a specfic scenario, it became a "scenario" task. When it was a simple combination input to output situation, it became a "drive" task. Ultimately, this ended up in the testbench being a bit messy, but it does confirm the functionality. I'm not trying to be incredibly rigorous with this testing, I just wanted it to be reliable. So I'm leaving it as is. I also didn't touch the forwarding checking, as that worked just fine, and had no changes made related to it.

I also created a macro that essentially acts as a function. It takes in a condition, a message, and 2 arguments. It asserts the condition, and if it fails it prints the message, including the 2 arguments in the string where applicable. This was added to the tb/common directory in a file called "tb_macros.sv", which from now on will contain tb related macros.

After the hazard TB was updated, I moved on to the other tests that were failing their tests. This mostly lead to testbenches being updated to reflect new expected behaviour. However, in one case there was an issue with the RTL. While debugging the branching buffer, it was found that the local predictors were behaving incorrectly. This was because of how the output was being assigned, how the newstate was being determined, and how the present state was being assigned. To say the least, it revealed a number of important issues in the RTL, which were then fixed.

I also updated some files to allow the regression parser to properly determine modules that contained parameters in their instantiation. The parser expects the module, as well as the instance name on the same line, however my current instantiation style for modules with parameters has the module name a couple of lines above the instance name. To solve this, I added a hack, where I duplicate the instance name on the same line as the module name, allowing the parser to find the module name. This isn't ideal, but it is an easy fix, and will work well enough.

### Summary:
- Fixed and updated hazard unit TB
- Fixed and updated all other failing test TB's
- Fixed issues in the local predictor RTL
- Fixed issues related to module parsing for compilation